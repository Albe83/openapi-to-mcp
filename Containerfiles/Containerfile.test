# syntax=docker/dockerfile:1.7
FROM python:3.11-slim-bookworm AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PATH="/opt/venv/bin:${PATH}"

WORKDIR /app
RUN python -m venv /opt/venv

ARG PIP_INSTALL_ARGS=""
ARG PIP_INDEX_URL=""
ARG PIP_EXTRA_INDEX_URL=""

COPY pyproject.toml README.md ./
RUN python - <<'PY' > /app/requirements.txt
import pathlib
import tomllib

meta = tomllib.loads(pathlib.Path("pyproject.toml").read_text(encoding="utf-8"))
project = meta["project"]
deps = list(project.get("dependencies", []))
optional = project.get("optional-dependencies", {})
deps.extend(optional.get("mcp", []))
deps.extend(optional.get("dev", []))
for dep in deps:
    print(dep)
PY
RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=tmpfs,target=/tmp \
    set -eu; \
    pip_args=""; \
    [ -n "${PIP_INDEX_URL}" ] && pip_args="${pip_args} --index-url ${PIP_INDEX_URL}" || true; \
    [ -n "${PIP_EXTRA_INDEX_URL}" ] && pip_args="${pip_args} --extra-index-url ${PIP_EXTRA_INDEX_URL}" || true; \
    [ -n "${PIP_INSTALL_ARGS}" ] && pip_args="${pip_args} ${PIP_INSTALL_ARGS}" || true; \
    PIP_NO_CACHE_DIR=0 pip install ${pip_args} -r /app/requirements.txt

COPY src/ src/
COPY tests/ tests/
RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=tmpfs,target=/tmp \
    set -eu; \
    pip_args=""; \
    [ -n "${PIP_INDEX_URL}" ] && pip_args="${pip_args} --index-url ${PIP_INDEX_URL}" || true; \
    [ -n "${PIP_EXTRA_INDEX_URL}" ] && pip_args="${pip_args} --extra-index-url ${PIP_EXTRA_INDEX_URL}" || true; \
    [ -n "${PIP_INSTALL_ARGS}" ] && pip_args="${pip_args} ${PIP_INSTALL_ARGS}" || true; \
    PIP_NO_CACHE_DIR=0 pip install ${pip_args} --no-deps .

RUN groupadd --gid 10001 app \
    && useradd --uid 10001 --gid app --home-dir /app --create-home --shell /usr/sbin/nologin app
USER app

CMD ["sh", "-lc", "python -m ruff check src tests && python -m pytest -q"]
