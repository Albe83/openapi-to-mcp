FROM python:3.11-slim-bookworm AS builder

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app

ARG PIP_INSTALL_ARGS=""
ARG PIP_INDEX_URL=""
ARG PIP_EXTRA_INDEX_URL=""

COPY pyproject.toml README.md ./
RUN python - <<'PY' > /app/requirements.txt
import pathlib
import tomllib

meta = tomllib.loads(pathlib.Path("pyproject.toml").read_text(encoding="utf-8"))
project = meta["project"]
deps = list(project.get("dependencies", []))
optional = project.get("optional-dependencies", {})
deps.extend(optional.get("mcp", []))
deps.extend(optional.get("dev", []))
for dep in deps:
    print(dep)
PY
RUN set -eu; \
    pip_args=""; \
    [ -n "${PIP_INDEX_URL}" ] && pip_args="${pip_args} --index-url ${PIP_INDEX_URL}" || true; \
    [ -n "${PIP_EXTRA_INDEX_URL}" ] && pip_args="${pip_args} --extra-index-url ${PIP_EXTRA_INDEX_URL}" || true; \
    [ -n "${PIP_INSTALL_ARGS}" ] && pip_args="${pip_args} ${PIP_INSTALL_ARGS}" || true; \
    pip install ${pip_args} -r /app/requirements.txt

COPY src/ src/
RUN set -eu; \
    pip_args=""; \
    [ -n "${PIP_INDEX_URL}" ] && pip_args="${pip_args} --index-url ${PIP_INDEX_URL}" || true; \
    [ -n "${PIP_EXTRA_INDEX_URL}" ] && pip_args="${pip_args} --extra-index-url ${PIP_EXTRA_INDEX_URL}" || true; \
    [ -n "${PIP_INSTALL_ARGS}" ] && pip_args="${pip_args} ${PIP_INSTALL_ARGS}" || true; \
    pip install ${pip_args} --no-deps .

FROM python:3.11-slim-bookworm AS runtime

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app
RUN groupadd --gid 10001 app \
    && useradd --uid 10001 --gid app --home-dir /app --create-home --shell /usr/sbin/nologin app

COPY --from=builder /usr/local /usr/local
COPY src/ src/
COPY tests/ tests/

USER app
EXPOSE 8080

CMD ["openapi-to-mcp"]
