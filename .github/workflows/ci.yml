name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install Dev Dependencies
        run: python -m pip install -e .[dev]

      - name: Lint
        run: make lint

      - name: Test
        run: make test

  container-build-verify:
    needs: lint-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify Docker
        run: docker info

      - name: Build Prod/Test (mount variant)
        env:
          OCI_BUILDER: docker
          CONTAINERFILE_VARIANT: mount
        run: |
          ./scripts/container-build.sh prod openapi-to-mcp:ci-prod-mount
          ./scripts/container-build.sh test openapi-to-mcp:ci-test-mount

      - name: Build Prod/Test (compat variant)
        env:
          OCI_BUILDER: docker
          CONTAINERFILE_VARIANT: compat
        run: |
          ./scripts/container-build.sh prod openapi-to-mcp:ci-prod-compat
          ./scripts/container-build.sh test openapi-to-mcp:ci-test-compat

      - name: Quality Test Containers
        env:
          OCI_RUNNER: docker
        run: |
          ./scripts/container-test.sh quality openapi-to-mcp:ci-test-mount
          ./scripts/container-test.sh quality openapi-to-mcp:ci-test-compat

      - name: Smoke Test Prod Containers
        env:
          WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          smoke_once() {
            image="$1"
            port="$2"
            cid="$(docker run -d --rm \
              -p "${port}:8080" \
              -v "${WORKSPACE}/tests/fixtures:/fixtures:ro" \
              -e OPENAPI_SPEC_PATH=/fixtures/sample-openapi.yaml \
              "${image}")"
            cleanup() {
              docker rm -f "${cid}" >/dev/null 2>&1 || true
            }
            trap cleanup RETURN
            for _ in $(seq 1 30); do
              if curl -fsS "http://127.0.0.1:${port}/healthz" >/dev/null
              then
                echo "Smoke check passed for ${image}"
                return 0
              fi
              sleep 1
            done
            echo "Smoke check failed for ${image}" >&2
            return 1
          }
          smoke_once openapi-to-mcp:ci-prod-mount 18080
          smoke_once openapi-to-mcp:ci-prod-compat 18081
